---
title: seccompの回避
date: 2022-02-05 12:43:00
tags:
    - [Linux]
    - [Userland]
    - [shellcode]
    - [seccomp]
lang: ja
---
Linuxではseccompと呼ばれるサンドボックス機構が提供されています。seccompは正しく使えば非常に強力ですが、フィルタの設定を誤ると簡単に回避できてしまいます。この章ではseccompの様々な回避手法について紹介します。

<div class="column" title="目次">
<!-- toc --><br>
</div>

## seccomp
seccompの回避方法について勉強する前に、seccompの仕組みについて知っておきましょう。

### seccompとは


### seccompの使い方


### seccomp-tools


### 禁止すべきシステムコール
では、seccompを使ってどのようなシステムコールを禁止すれば良いのでしょうか。プログラムや保護したいものによりますが、一般的には任意コマンド実行や任意ファイル読み書きを防ぐ目的で使われます。
コマンド実行に関しては次のシステムコールを禁止すれば十分です。

- `execve`
- `execveat`

また、ファイル読み書きに関しては次のシステムコールを禁止します。`creat`は忘れがちなので注意が必要ですね。

- `creat`
- `open`
- `openat`

もしプログラムがroot権限で動いているなら、ファイルopenに関して次のシステムコールも禁止する必要があります。（当然root権限の場合は他にもたくさんのシステムコールを禁止しないといけないです。）

- `name_to_handle_at`
- `open_by_handle_at`

DoSなどの悪さを禁止するなら、他にも

- `clone`
- `fork` / `vfork`
- `kill` / `tkill` / `tgkill`
- `prlimit64`

などさまざまなシステムコールを禁止する必要があります。
このように、seccompをブラックリスト方式で使うのは非常に大変です。そのため、特別な理由がない限りはプログラムが使う安全なシステムコールのみを許可するホワイトリスト方式で使用しましょう。

## ブラックリストの不備
ここからはseccompの回避方法について説明します。まず、ブラックリスト方式を利用した際の不備を悪用する方法を紹介します。

### openatとexecveat


### creatとprocfs


### process\_vm\_readv, process\_vm\_writev


### open\_by\_handle\_at, name\_to\_handle\_at


## サイドチャネル攻撃
メモリ上の情報漏洩が目的で、コマンド実行などが不要な場合もあります。このような場合はシステムコールを利用せずに情報漏洩が可能かもしれません。

### エラーの観測


### 処理時間の計測


## その他の回避手法


### 他プロセスの悪用

#### kill, tkill, tgkill


#### prlimit64



### カーネルやライブラリの欠陥の利用

